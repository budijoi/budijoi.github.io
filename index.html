import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
// Kita menghapus kebutuhan login manual, tapi tetap bisa init firebase jika nanti butuh fitur lain
import { getAuth } from 'firebase/auth';
import { 
  Camera, Upload, Download, Share2, MessageCircle, 
  Heart, X, AlertTriangle, Send, DollarSign, 
  Menu, LogOut, Image as ImageIcon, Sparkles, Loader2, Edit3, RefreshCw, Copy,
  UserCheck, Move, ChevronDown
} from 'lucide-react';

// --- KONFIGURASI FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config || '{}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app); // Auth tetap di-init tapi tidak dipaksakan ke user

// --- KONFIGURASI GEMINI API ---
// API Key otomatis ditangani oleh environment runtime (browser context)
const apiKey = ""; 

// --- DATA STYLES ---
const STYLE_CATEGORIES = [
  {
    label: "Disney / Pixar-like",
    basePrompt: "western cartoon style, Disney-like, Pixar-inspired, smooth shapes, vibrant colors, soft cartoon shading, clean lineart, expressive facial expression, friendly character design, stylized proportions, non-realistic, 2D cartoon illustration",
    negative: "realistic, photorealistic, cinematic lighting, skin texture, pores, wrinkles, photo, 3D render, ultra detailed",
    options: [
      { id: 'western_gen', name: 'General Disney/Pixar Style' },
      { id: 'adv_time', name: 'Adventure Time' },
      { id: 'spider_verse', name: 'Spider-Verse' },
      { id: 'incredibles', name: 'The Incredibles' },
      { id: 'samurai_jack', name: 'Samurai Jack' },
      { id: 'superman', name: 'Superman' },
      { id: 'batman', name: 'Batman' },
      { id: 'spongebob', name: 'Spongebob' },
      { id: 'aladdin', name: 'Aladdin' },
      { id: 'beauty_and_the_beast', name: 'Beauty And The Beast' },
      { id: 'litte_mermaid', name: 'Little Mermaid' },
      { id: 'cinderella', name: 'Cinderella' },
      { id: 'snow_white', name: 'Snow White' },
      { id: 'powerpuff', name: 'The Powerpuff Girls' }
    ]
  },
  {
    label: "Anime / Manga",
    basePrompt: "anime style, manga illustration, cel shading, sharp clean lineart, stylized anime proportions, large expressive eyes, flat colors, 2D illustration, non-realistic, hand-drawn look",
    negative: "realistic face, photorealistic, real skin texture, cinematic lighting, 3D, photo",
    options: [
      { id: 'anime_gen', name: 'General Anime/Manga' },
      { id: 'jojo', name: "JoJo's Bizarre Adventure" },
      { id: 'ghibli', name: 'Studio Ghibli' },
      { id: 'one_piece', name: 'One Piece' },
      { id: 'akira', name: 'Akira' },
      { id: 'doraemon', name: 'Doraemon' },
      { id: 'naruto', name: 'Naruto' },
      { id: 'pokemon', name: 'Pokémon' },
      { id: 'demon_slayer', name: 'Demon Slayer' },
      { id: 'gundam', name: 'Gundam' },
      { id: 'detective_conan', name: 'Det. Conan' },
      { id: 'dragon_ball', name: 'Dragon Ball' },
      { id: 'titan', name: 'Attack On Titan' },
      { id: 'samurai_x', name: 'Rurouni Kenshin (Samurai X)' },
      { id: 'chainsaw', name: 'Chainsaw Man' }
    ]
  },
  {
    label: "Graphic Novel",
    basePrompt: "graphic novel style, indie comic art, ink illustration, bold black lines, minimal shading, high contrast, rough sketch texture, hand-drawn look, stylized anatomy, non-realistic, limited color palette",
    negative: "realistic, smooth rendering, photorealistic, cinematic lighting, 3D render, photo",
    options: [
      { id: 'indie_gen', name: 'General Graphic Novel' },
      { id: 'scott_pilgrim', name: 'Scott Pilgrim' },
      { id: 'persepolis', name: 'Persepolis' },
      { id: 'sin_city', name: 'Sin City' },
      { id: 'walking_dead', name: 'The Walking Dead' },
      { id: 'junji_ito', name: 'Junji Ito Remina' },
      { id: 'contract_with_god', name: 'Contract With God' },
      { id: 'black_hole', name: 'Black Hole' },
      { id: 'manhunter', name: 'Manhunter' },
      { id: 'incal', name: 'The Incal' },
    ]
  },
  {
    label: "Chibi",
    basePrompt: "chibi style, super deformed character, big head small body, cute proportions, simple shapes, bright colors, soft shading, kawaii style, 2D illustration, non-realistic, adorable expression",
    negative: "realistic anatomy, realistic face, photorealistic, detailed skin, cinematic lighting, 3D",
    options: [
      { id: 'chibi_gen', name: 'General Chibi/Cute' },
      { id: 'hello_kitty', name: 'Hello Kitty' },
      { id: 'aggretsuko', name: 'Aggretsuko' },
      { id: 'hamtaro', name: 'Hamtaro' },
      { id: 'sanrio', name: 'Sanrio Style' }
    ]
  },
   {
    label: "Flat Cute",
    basePrompt: "Cute modern flat cartoon illustration of [SUBJECT], friendly and casual pose, Clean thick line art with rounded edges, flat colors with soft simple shading, Minimalist facial features, round eyes, small nose, subtle blush on cheeks, Semi-chibi proportions, slightly larger head, simplified body anatomy, Warm pastel color palette, soft and cheerful mood, Minimal background with simple shapes and small sparkles, Vector-style digital illustration, clean, smooth, high quality",
    negative: "realistic, photorealistic, 3d render, anime manga style, detailed texture, dramatic lighting, hyper detailed, gritty, dark mood",
    options: [
      { id: 'flat_gen', name: 'General Flat Cute' },
    ]
  }
];

const DEFAULT_STYLE = STYLE_CATEGORIES[0].options[0];
const DEFAULT_CATEGORY = STYLE_CATEGORIES[0];

const ADMIN_WA = "6287784183394";
const DONASI_DANA = "085323073037";

// --- HELPER: CLIPBOARD FALLBACK ---
const copyToClipboard = (text) => {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed'; // Avoid scrolling to bottom
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
    return true;
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
    return false;
  } finally {
    document.body.removeChild(textarea);
  }
};

// --- HELPER: IMAGE COMPRESSION & SIGNATURE ---
const processGeneratedImage = async (rawBase64) => {
  return new Promise((resolve) => {
    const img = new Image();
    img.src = `data:image/jpeg;base64,${rawBase64}`;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX_SIZE = 1280; 
      let width = img.width;
      let height = img.height;

      if (width > height) {
        if (width > MAX_SIZE) {
          height *= MAX_SIZE / width;
          width = MAX_SIZE;
        }
      } else {
        if (height > MAX_SIZE) {
          width *= MAX_SIZE / height;
          height = MAX_SIZE;
        }
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      // --- SIGNATURE BARKOM ---
      const fontSize = Math.floor(Math.max(20, width * 0.05)); 
      ctx.font = `900 ${fontSize}px sans-serif`; 
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; 
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)'; 
      ctx.lineWidth = fontSize / 8;
      ctx.textAlign = 'right';
      ctx.textBaseline = 'bottom';
      
      const paddingX = width * 0.03;
      const paddingY = height * 0.03;
      
      const text = "BarKom";
      ctx.strokeText(text, width - paddingX, height - paddingY);
      ctx.fillText(text, width - paddingX, height - paddingY);
      // -------------------------

      resolve(canvas.toDataURL('image/jpeg', 0.8)); 
    };
    img.onerror = () => {
        resolve(`data:image/jpeg;base64,${rawBase64}`);
    }
  });
};

// --- KOMPONEN UI ---

const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
  const baseStyle = "font-bold border-2 border-black rounded-lg px-4 py-2 transition-all active:translate-y-1 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[1px] hover:translate-y-[1px]";
  const variants = {
    primary: "bg-yellow-400 text-black hover:bg-yellow-300",
    secondary: "bg-white text-black hover:bg-gray-100",
    danger: "bg-red-500 text-white hover:bg-red-400",
    success: "bg-green-500 text-white hover:bg-green-400",
    blue: "bg-blue-400 text-black hover:bg-blue-300"
  };

  return (
    <button 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed shadow-none translate-y-1' : ''}`}
    >
      {children}
    </button>
  );
};

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white border-4 border-black rounded-xl w-full max-w-md p-6 relative shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] animate-in zoom-in-95 duration-200">
        <button onClick={onClose} className="absolute top-4 right-4 p-1 hover:bg-red-100 rounded-full border-2 border-transparent hover:border-black transition-all">
          <X size={24} />
        </button>
        <h2 className="text-2xl font-black mb-4 uppercase tracking-tighter border-b-4 border-black pb-2 inline-block">{title}</h2>
        {children}
      </div>
    </div>
  );
};

// --- APP UTAMA ---

export default function BarKomApp() {
  // State
  const [loading, setLoading] = useState(false);
  const [showWarning, setShowWarning] = useState(false);
  const [inputImage, setInputImage] = useState(null);
  
  // Style States
  const [selectedStyleId, setSelectedStyleId] = useState(DEFAULT_STYLE.id);
  const [customStyle, setCustomStyle] = useState(''); 
  
  // Pose Options State (DIHAPUS - Selalu Kreatif)
  // const [maintainPose, setMaintainPose] = useState(true); 

  const [isGenerating, setIsGenerating] = useState(false);
  const [generatedResults, setGeneratedResults] = useState([]);
  
  // Caption States
  const [captionText, setCaptionText] = useState("Fakta seru komik akan muncul di sini setelah gambar selesai!");
  const [isCaptionLoading, setIsCaptionLoading] = useState(false);

  // Modal States
  const [showSaran, setShowSaran] = useState(false);
  const [showDonasi, setShowDonasi] = useState(false);
  
  // Form States
  const [saranForm, setSaranForm] = useState({ nama: '', isi: '' });
  const [donasiAmount, setDonasiAmount] = useState('');

  // Refs
  const fileInputRef = useRef(null);

  // --- INIT ---
  useEffect(() => {
    const hasSeenWarning = localStorage.getItem('barkom_warning_seen');
    if (!hasSeenWarning) {
      setShowWarning(true);
    }
  }, []);

  const closeWarning = () => {
    setShowWarning(false);
    localStorage.setItem('barkom_warning_seen', 'true');
  };

  // --- HELPER: GET CURRENT STYLE DATA ---
  const getCurrentStyleData = () => {
    for (const cat of STYLE_CATEGORIES) {
      const found = cat.options.find(opt => opt.id === selectedStyleId);
      if (found) {
        return {
          ...found,
          categoryPrompt: cat.basePrompt,
          negativePrompt: cat.negative
        };
      }
    }
    return {
      ...DEFAULT_STYLE,
      categoryPrompt: DEFAULT_CATEGORY.basePrompt,
      negativePrompt: DEFAULT_CATEGORY.negative
    };
  };

  // --- IMAGE HANDLING ---
  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setInputImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleDragOver = (e) => {
    e.preventDefault();
  };

  const handleDrop = (e) => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setInputImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  // --- CAPTION GENERATION LOGIC ---
  const fetchCaption = async (forcedTopic = null) => {
    setIsCaptionLoading(true);
    
    let topicInstruction = "tentang dunia kartun dan komik (anime, manga, western comics, webtoon dll) dari seluruh dunia secara umum";
    
    // Selalu gunakan topik spesifik karena sekarang selalu Creative Mode
    if (forcedTopic) {
        topicInstruction = `secara SPESIFIK tentang gaya/genre/judul: "${forcedTopic}". Berikan trivia unik tentang gaya tersebut`;
    } else {
        const styleData = getCurrentStyleData();
        const styleName = customStyle || styleData.name;
        topicInstruction = `secara SPESIFIK tentang gaya/genre/judul: "${styleName}". Berikan trivia unik tentang gaya tersebut`;
    }

    const prompt = `Berikan satu fakta unik, trivia menarik, atau info seru ${topicInstruction}. 
    Gunakan Bahasa Indonesia yang santai, gaul, dan menarik untuk caption media sosial. 
    Maksimal 30 kata. 
    Tambahkan hashtag #barkom #faktakomik #budijoi`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) {
        setCaptionText(text);
      }
    } catch (e) {
      console.error("Caption error", e);
      setCaptionText("Tahukah kamu? Komik pertama di dunia yang diakui adalah The Yellow Kid! #barkom #faktakomik");
    } finally {
      setIsCaptionLoading(false);
    }
  };

  // --- API GENERATION LOGIC ---
  const generateImages = async () => {
    if (!inputImage) {
      alert("Upload foto dulu dong!");
      return;
    }

    setIsGenerating(true);
    setGeneratedResults([]); 
    setCaptionText("Menunggu hasil gambar..."); 

    const cleanBase64 = inputImage.split(',')[1];
    
    // Tentukan style prompt & Name
    let stylePromptToUse = "";
    let negativePromptToUse = "";
    let currentStyleName = "";
    
    if (customStyle.trim()) {
      stylePromptToUse = customStyle;
      currentStyleName = customStyle;
      negativePromptToUse = "photorealistic, realistic lighting, skin texture, photo, ultra-detailed, cinematic, 8k, DSLR.";
    } else {
      const styleData = getCurrentStyleData();
      currentStyleName = styleData.name;
      stylePromptToUse = `${styleData.name} style, ${styleData.categoryPrompt}`;
      negativePromptToUse = styleData.negativePrompt;
    }
    
    // --- Prompt Konstruksi Dinamis (SELALU KREATIF + DETEKSI SUBJEK) ---
    const instructionBlock = `SMART SUBJECT ADAPTATION:
        1. ANALYZE CONTENT: Identify if the image contains Humans (Men, Women, Children, Groups) or Non-Humans (Animals, Objects, Vehicles, Scenery).
        
        2. IF NON-HUMAN (Animals, Objects, Scenery): 
           - Transform the subject into the ${currentStyleName} style. 
           - CRITICAL: DO NOT transform animals/objects into humans. DO NOT add humans if they are not in the original photo.
           - Stylize the textures and forms to fit the aesthetic perfectly.
           
        3. IF HUMAN: 
           - Transform into ${currentStyleName} characters.
           - CRITICAL: Preserve the Gender (Man/Woman), Age (Child/Adult), and Group Composition exactly as seen in the photo.
           - Change the body posture/pose to be more dynamic, expressive, or action-oriented suitable for a comic character.
           
        4. CREATIVE ENHANCEMENT:
           - Replace the background with a detailed scene fitting the ${currentStyleName} world/aesthetic.
           - Add visual effects, particles, or elements typical of ${currentStyleName} (e.g. speed lines for anime, magic sparkles for disney, gritty texture for indie).`;

    const imagePrompt = `Transform the subject(s) of this image into a ${stylePromptToUse}.
    
    ${instructionBlock}
    
    NEGATIVE PROMPT (Avoid these styles): ${negativePromptToUse}`;

    try {
      const totalImages = 2;
      let successCount = 0;
      
      for (let i = 1; i <= totalImages; i++) {
        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { text: imagePrompt },
                  { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } }
                ]
              }],
              generationConfig: {
                responseModalities: ["IMAGE"] 
              }
            })
          });

          const data = await response.json();
          const imgBase64 = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
          
          if (imgBase64) {
             const optimizedSrc = await processGeneratedImage(imgBase64);

             const newResult = {
               id: Date.now() + i,
               src: optimizedSrc
             };

             setGeneratedResults(prev => [...prev, newResult]);
             successCount++;
          }
        } catch (err) {
          console.error(`Error generating image ${i}:`, err);
        }
      }
      
      // Fetch Caption setelah selesai
      if (successCount > 0) {
          // Selalu fetch info style
          fetchCaption(currentStyleName);
      } else {
          setCaptionText("Gagal membuat gambar, jadi tidak ada fakta komik nih :(");
      }

    } catch (error) {
      console.error("Generation Error:", error);
      alert("Maaf, terjadi kesalahan saat generate gambar. Pastikan koneksi lancar ya!");
    } finally {
      setIsGenerating(false);
    }
  };

  // --- ACTIONS ---
  const handleShare = async (imgSrc, caption) => {
    const success = copyToClipboard(caption);
    if (success) {
        alert("Caption & Hashtag disalin! Silakan paste saat membagikan gambar.");
    } else {
        alert("Gagal menyalin caption otomatis.");
    }

    try {
      const a = document.createElement('a');
      a.href = imgSrc;
      a.download = `barkom-${Date.now()}.jpg`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } catch (err) {
      alert("Gagal membagikan otomatis. Gambar akan diunduh.");
    }
  };

  const handleCopyCaption = () => {
      const success = copyToClipboard(captionText);
      if (success) {
          alert("Caption berhasil disalin!");
      } else {
          alert("Gagal menyalin caption.");
      }
  };

  const handleSave = (imgSrc) => {
    const a = document.createElement('a');
    a.href = imgSrc;
    a.download = `barkom-${Date.now()}.jpg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  const sendSaran = () => {
    if (!saranForm.nama || !saranForm.isi) return alert("Isi semua kolom dulu!");
    const text = `Halo Admin BarKom, Saya ${saranForm.nama}. Saya punya saran: ${saranForm.isi}`;
    const url = `https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
    setShowSaran(false);
    setSaranForm({ nama: '', isi: '' });
  };

  const sendDonasi = () => {
    if (!donasiAmount) return alert("Isi nominal donasi dulu!");
    const text = `Halo Admin, saya ingin konfirmasi donasi untuk BarKom sebesar Rp ${donasiAmount} via DANA.`;
    const url = `https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
    setShowDonasi(false);
    setDonasiAmount('');
  };

  // --- RENDER ---

  if (loading) return (
    <div className="min-h-screen bg-yellow-300 flex items-center justify-center font-bold text-2xl animate-pulse">
      Memuat BarKom...
    </div>
  );

  return (
    <div className="min-h-screen bg-[#fffdf5] text-gray-900 font-sans selection:bg-yellow-200 flex flex-col">
      
      {/* WARNING MODAL */}
      <Modal isOpen={showWarning} onClose={closeWarning} title="PERINGATAN PENTING!">
        <div className="text-center space-y-4">
          <div className="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center border-2 border-red-500">
            <AlertTriangle className="text-red-500 w-8 h-8" />
          </div>
          <p className="font-bold text-lg">Aplikasi ini 100% GRATIS!</p>
          <p className="text-sm text-gray-700">
            Jika ada pihak yang meminta bayaran untuk akses aplikasi ini, berarti Anda sedang <span className="font-black text-red-600">DITIPU</span>.
          </p>
          <p className="text-sm text-gray-700">
            Admin aplikasi hanya menerima <span className="font-bold">DONASI SUKARELA</span> dan bukan paksaan.
          </p>
          <Button onClick={closeWarning} variant="primary" className="w-full">
            Saya Mengerti
          </Button>
        </div>
      </Modal>

      {/* SARAN MODAL */}
      <Modal isOpen={showSaran} onClose={() => setShowSaran(false)} title="Kotak Saran">
        <div className="space-y-4">
          <div>
            <label className="block font-bold text-sm mb-1">Nama Kamu</label>
            <input 
              type="text" 
              className="w-full border-2 border-black rounded-lg p-2 focus:ring-2 focus:ring-yellow-400 outline-none"
              value={saranForm.nama}
              onChange={e => setSaranForm({...saranForm, nama: e.target.value})}
              placeholder="Budi Joi"
            />
          </div>
          <div>
            <label className="block font-bold text-sm mb-1">Isi Saran</label>
            <textarea 
              className="w-full border-2 border-black rounded-lg p-2 h-24 focus:ring-2 focus:ring-yellow-400 outline-none resize-none"
              value={saranForm.isi}
              onChange={e => setSaranForm({...saranForm, isi: e.target.value})}
              placeholder="Tambahin fitur baru dong min..."
            />
          </div>
          <Button onClick={sendSaran} variant="success" className="w-full flex justify-center items-center gap-2">
            <Send size={18} /> Kirim ke WhatsApp
          </Button>
        </div>
      </Modal>

      {/* DONASI MODAL */}
      <Modal isOpen={showDonasi} onClose={() => setShowDonasi(false)} title="Donasi Developer">
        <div className="space-y-4 text-center">
          <p className="text-sm">Bantu server tetap hidup dengan donasi seikhlasnya!</p>
          <div className="bg-blue-100 border-2 border-blue-500 p-3 rounded-lg">
            <p className="font-bold text-blue-800">DANA: {DONASI_DANA}</p>
          </div>
          <div>
            <label className="block font-bold text-sm mb-1 text-left">Nominal (Rp)</label>
            <input 
              type="number" 
              className="w-full border-2 border-black rounded-lg p-2 focus:ring-2 focus:ring-yellow-400 outline-none"
              value={donasiAmount}
              onChange={e => setDonasiAmount(e.target.value)}
              placeholder="Contoh: 10000"
            />
          </div>
          <Button onClick={sendDonasi} variant="blue" className="w-full flex justify-center items-center gap-2">
            <DollarSign size={18} /> Konfirmasi via WhatsApp
          </Button>
        </div>
      </Modal>

      {/* HEADER */}
      <header className="bg-white border-b-4 border-black sticky top-0 z-40">
        <div className="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="bg-yellow-400 p-2 border-2 border-black rounded-md rotate-3">
              <Sparkles size={24} className="text-black" />
            </div>
            <h1 className="text-2xl md:text-3xl font-black tracking-tighter italic">BarKom</h1>
          </div>
          <div>
             <div className="font-bold text-sm bg-gray-100 px-3 py-1 rounded-full border-2 border-black">
                Mode Tamu
             </div>
          </div>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <main className="max-w-5xl mx-auto px-4 py-8 pb-12 flex-grow w-full">
        
        {/* HERO */}
        <div className="text-center mb-8">
            <h2 className="text-lg font-medium text-gray-600">Ubah Gambar Kamu Menjadi Komik</h2>
        </div>

        {/* EDITOR AREA - Langsung Tampil */}
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* LEFT: CONTROLS */}
          <div className="lg:col-span-4 space-y-6">
            
            {/* UPLOAD BOX */}
            <div className="bg-white p-4 border-4 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
              <h3 className="font-black text-xl mb-3 flex items-center gap-2">
                <Camera size={20} /> 1. Upload Foto
              </h3>
              <div 
                className="border-2 border-dashed border-gray-400 bg-gray-50 rounded-xl h-64 flex flex-col items-center justify-center cursor-pointer hover:bg-yellow-50 hover:border-yellow-400 transition-colors relative overflow-hidden group"
                onDragOver={handleDragOver}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current.click()}
              >
                {inputImage ? (
                  <img src={inputImage} alt="Preview" className="w-full h-full object-cover" />
                ) : (
                  <>
                    <Upload size={48} className="text-gray-400 mb-2 group-hover:scale-110 transition-transform" />
                    <p className="text-gray-500 font-bold">Klik atau Tarik Foto Kesini</p>
                  </>
                )}
                {inputImage && (
                  <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <p className="text-white font-bold">Ganti Foto</p>
                  </div>
                )}
              </div>
              <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept="image/*" />
            </div>

            {/* STYLE SELECTOR (DROPDOWN) */}
            <div className="bg-white p-4 border-4 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
              <h3 className="font-black text-xl mb-3 flex items-center gap-2">
                <ImageIcon size={20} /> 2. Pilih Gaya
              </h3>
              
              {/* Manual Input */}
              <div className="mb-4">
                <div className="relative">
                    <input 
                      type="text" 
                      placeholder="Atau ketik gaya sendiri (misal: Cyberpunk, 3D Pixar...)" 
                      className="w-full border-2 border-black rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-yellow-400 outline-none"
                      value={customStyle}
                      onChange={(e) => setCustomStyle(e.target.value)}
                    />
                    <Edit3 size={18} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500" />
                </div>
                {customStyle && <p className="text-xs text-green-600 mt-1 font-bold">* Menggunakan gaya manual Anda</p>}
              </div>

              {/* DROPDOWN MENU */}
              <div className={`relative ${customStyle ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                 <div className="relative">
                     <select 
                        value={selectedStyleId}
                        onChange={(e) => setSelectedStyleId(e.target.value)}
                        className="w-full appearance-none bg-gray-50 border-2 border-black text-gray-900 text-sm rounded-lg focus:ring-yellow-400 focus:border-black block w-full p-3 pr-8 font-bold cursor-pointer hover:bg-yellow-50 transition-colors"
                     >
                        {STYLE_CATEGORIES.map((category, idx) => (
                           <optgroup key={idx} label={category.label} className="font-bold text-gray-900 bg-gray-100">
                              {category.options.map((style) => (
                                 <option key={style.id} value={style.id} className="font-medium bg-white py-2">
                                    {style.name}
                                 </option>
                              ))}
                           </optgroup>
                        ))}
                     </select>
                     <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <ChevronDown size={20} />
                     </div>
                 </div>
                 <p className="text-xs text-gray-500 mt-2">Pilih kategori dan gaya spesifik dari menu di atas.</p>
              </div>
            </div>

            {/* GENERATE BUTTON */}
            <Button 
              onClick={generateImages} 
              disabled={isGenerating || !inputImage}
              className="w-full text-xl py-4 flex justify-center items-center gap-2"
              variant="success"
            >
              {isGenerating ? (
                <><Loader2 className="animate-spin" /> Proses...</>
              ) : (
                <><Sparkles /> GENERATE (2 Gambar)</>
              )}
            </Button>

          </div>

          {/* RIGHT: RESULTS */}
          <div className="lg:col-span-8">
            <div className="bg-white min-h-[500px] border-4 border-black rounded-xl p-6 relative shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] bg-pattern-dots">
              <h3 className="font-black text-2xl mb-6 bg-white inline-block px-4 py-1 border-2 border-black rotate-[-1deg]">
                HASIL KARYA
              </h3>

              {generatedResults.length === 0 && !isGenerating && (
                <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
                  <ImageIcon size={64} className="mb-4 opacity-50" />
                  <p className="font-bold text-xl">Belum ada gambar</p>
                  <p>Upload foto dan pilih gaya dikiri!</p>
                </div>
              )}
              
              {/* Full overlay only if no results yet */}
              {isGenerating && generatedResults.length === 0 && (
                  <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-10 backdrop-blur-sm rounded-lg">
                    <Loader2 size={64} className="text-yellow-500 animate-spin mb-4" />
                    <p className="font-black text-xl animate-pulse">Sedang menggambar komikmu...</p>
                    <p className="text-sm mt-2">Memproses gambar 1 dari 2...</p>
                    <p className="text-xs text-gray-500 mt-1">
                        Menciptakan pose aksi & background sesuai gaya...
                    </p>
                  </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                {generatedResults.map((result) => (
                  <div key={result.id} className="bg-white border-4 border-black p-2 rounded-lg hover:rotate-1 transition-transform duration-300 animate-in zoom-in-50">
                    <div className="aspect-square bg-gray-200 mb-2 overflow-hidden border-2 border-black rounded-md">
                      <img src={result.src} alt="Result" className="w-full h-full object-cover" />
                    </div>
                    <div className="flex gap-2">
                      <Button onClick={() => handleSave(result.src)} variant="secondary" className="flex-1 text-sm py-1 flex justify-center gap-1">
                        <Download size={14} /> Simpan
                      </Button>
                      <Button onClick={() => handleShare(result.src, captionText)} variant="blue" className="flex-1 text-sm py-1 flex justify-center gap-1">
                        <Share2 size={14} /> Share
                      </Button>
                    </div>
                  </div>
                ))}

                {/* Loading Placeholder for Next Image */}
                {isGenerating && generatedResults.length > 0 && generatedResults.length < 2 && (
                    <div className="bg-gray-50 border-4 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center min-h-[300px] animate-pulse">
                        <Loader2 size={48} className="text-gray-400 animate-spin mb-2" />
                        <p className="text-gray-500 font-bold">Sedang menggambar variasi 2...</p>
                    </div>
                )}
              </div>

              {/* AUTO CAPTION COLUMN - MUNCUL SETELAH SEMUA SELESAI */}
              {!isGenerating && generatedResults.length > 0 && (
                  <div className="bg-yellow-100 border-4 border-black rounded-lg p-4 relative shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] animate-in slide-in-from-bottom-5 fade-in duration-500">
                     <div className="flex justify-between items-center mb-2">
                        <h4 className="font-black text-lg flex items-center gap-2">
                           <Sparkles size={18} className="text-purple-600" /> 
                           FAKTA GAYA INI
                        </h4>
                        <div className="flex gap-2">
                           <button onClick={handleCopyCaption} className="p-1 hover:bg-yellow-200 rounded-full border border-black" title="Salin">
                              <Copy size={16} />
                           </button>
                           <button 
                              onClick={() => fetchCaption(customStyle || getCurrentStyleData().name)} 
                              disabled={isCaptionLoading}
                              className={`p-1 hover:bg-yellow-200 rounded-full border border-black transition-transform ${isCaptionLoading ? 'animate-spin' : 'hover:rotate-180'}`} 
                              title="Refresh Caption"
                            >
                              <RefreshCw size={16} />
                           </button>
                        </div>
                     </div>
                     
                     <div className="bg-white border-2 border-black p-3 rounded-lg min-h-[60px] flex items-center relative">
                        {isCaptionLoading ? (
                            <div className="flex items-center gap-2 text-gray-500 w-full justify-center">
                                <Loader2 size={16} className="animate-spin" /> Mencari info unik...
                            </div>
                        ) : (
                            <p className="font-mono text-sm leading-relaxed w-full">
                               {captionText}
                            </p>
                        )}
                     </div>
                     <p className="text-[10px] text-gray-500 mt-1 text-right italic">
                        *Gunakan caption ini saat share ke sosmed!
                     </p>
                  </div>
              )}

            </div>
          </div>
        </div>

        {/* STATIC ACTION BUTTONS - CENTERED BOTTOM */}
        <div className="max-w-5xl mx-auto flex justify-center items-center gap-4 mt-12 mb-4">
            <Button onClick={() => setShowSaran(true)} variant="secondary" className="flex items-center gap-2 rounded-full px-6 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] bg-pink-100 hover:bg-pink-200">
                <MessageCircle size={20} /> <span className="hidden md:inline">Saran</span>
            </Button>
            
            <Button onClick={() => setShowDonasi(true)} variant="primary" className="flex items-center gap-2 rounded-full px-6 py-3 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:scale-105 transition-transform">
                <Heart size={20} className="fill-red-500 text-red-500" /> Donasi
            </Button>
        </div>

      </main>

      {/* FOOTER */}
      <footer className="bg-black text-white py-12 mt-auto">
        <div className="max-w-5xl mx-auto px-4 text-center">
          <div className="flex justify-center gap-6 mb-8 flex-wrap">
            <a href="https://facebook.com/budijoiBBJ" target="_blank" rel="noreferrer" className="hover:text-yellow-400 transition-colors flex items-center gap-2 font-bold"><span className="p-2 bg-white text-black rounded-full"><Share2 size={16}/></span> FB</a>
            <a href="https://instagram.com/budijoi_eco" target="_blank" rel="noreferrer" className="hover:text-yellow-400 transition-colors flex items-center gap-2 font-bold"><span className="p-2 bg-white text-black rounded-full"><Camera size={16}/></span> IG</a>
            <a href="https://thread.com/budijoi_eco" target="_blank" rel="noreferrer" className="hover:text-yellow-400 transition-colors flex items-center gap-2 font-bold"><span className="p-2 bg-white text-black rounded-full"><Menu size={16}/></span> Threads</a>
            <a href={`https://wa.me/${ADMIN_WA}`} target="_blank" rel="noreferrer" className="hover:text-yellow-400 transition-colors flex items-center gap-2 font-bold"><span className="p-2 bg-white text-black rounded-full"><MessageCircle size={16}/></span> WA</a>
            <a href="mailto:premipahe@gmail.com" className="hover:text-yellow-400 transition-colors flex items-center gap-2 font-bold"><span className="p-2 bg-white text-black rounded-full"><Send size={16}/></span> Email</a>
          </div>
          <p className="font-mono text-gray-400 text-sm">
            © 2024 BarKom by Budijoi. Dibuat dengan cinta dan kopi.
          </p>
          <p className="text-xs text-gray-600 mt-2">
            Aplikasi ini menggunakan teknologi AI. Hasil gambar mungkin bervariasi.
          </p>
        </div>
      </footer>

      <style>{`
        .bg-pattern-dots {
          background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
          background-size: 20px 20px;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
      `}</style>
    </div>
  );
}
